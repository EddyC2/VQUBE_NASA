<!DOCTYPE html>
<html>
  <head>
    <title>World Pollution Globe</title>
    <style>
      body { 
        margin: 0; 
        font-family: Arial, sans-serif;
        overflow: hidden;
        background: #000;
      }
      #globeViz {
        width: 100vw;
        height: 100vh;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background: rgba(0,0,0,0.8);
        padding: 20px 40px;
        border-radius: 10px;
        font-size: 16px;
        text-align: center;
        z-index: 1000;
      }
      #controls {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        background: rgba(0,0,0,0.8);
        padding: 15px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 100;
        display: none;
        max-height: 90vh;
        overflow-y: auto;
      }
      #trendControls {
      margin-top: 15px;
      }

      #controls h3, #trendControls h3 {
        margin-top: 0;
        margin-bottom: 10px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .legend-item:hover {
        background: rgba(255,255,255,0.1);
      }
      .legend-item.inactive {
        opacity: 0.3;
      }
      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 3px;
        border: 2px solid transparent;
        transition: border 0.2s;
      }
      .legend-item.active .legend-color {
        border-color: white;
      }
      #yearSlider {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 50%;
        max-width: 600px;
        z-index: 200;
        height: 30px;
        cursor: pointer;
      }
      
      #yearLabel {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 20px;
        font-weight: bold;
        z-index: 200;
        background: rgba(0,0,0,0.8);
        padding: 10px 20px;
        border-radius: 8px;
      }
      #storyBtn, #storyText {
        position: absolute;
        z-index: 10000 !important;
      }
      #storyBtn {
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div>üåç Loading World Globe...</div>
      <div style="margin-top: 10px; font-size: 12px;">Loading pollution data...</div>
    </div>
    
    <div id="controls">
      <h3>üåç World CO‚ÇÇ Predictions</h3>
      <p style="font-size: 11px; margin-bottom: 10px;">Click to filter by level:</p>
      <div class="legend-item active" data-level="high">
        <div class="legend-color" style="background: #d73027;"></div>
        <span>High (>66)</span>
      </div>
      <div class="legend-item active" data-level="medium">
        <div class="legend-color" style="background: #fdae61;"></div>
        <span>Mid (33-66)</span>
      </div>
      <div class="legend-item active" data-level="low">
        <div class="legend-color" style="background: #4daf4a;"></div>
        <span>Low (<33)</span>
      </div>
      
      <!-- Emission Trends goes right under it -->
      <div id="trendControls" style="margin-top: 15px;">
        <h3>üìà Emission Trends</h3>
        <p style="font-size: 11px; margin-bottom: 10px;">Bubbles show trends:</p>
        <div class="legend-item active" data-trend="increasing">
          <div class="legend-color" style="background: #FF6B35;"></div>
          <span>Increasing</span>
        </div>
        <div class="legend-item active" data-trend="steady">
          <div class="legend-color" style="background: purple;"></div>
          <span>Steady</span>
        </div>
        <div class="legend-item active" data-trend="decreasing">
          <div class="legend-color" style="background: #95E1D3;"></div>
          <span>Decreasing</span>
        </div>
      </div>
    
      <p style="font-size: 11px; margin-top: 15px; opacity: 0.8;">
        Hover over countries for details<br>
        (Shows CDA, GHP, PAR data)<br>
        Drag to rotate ‚Ä¢ Scroll to zoom
      </p>
    </div>
    

    <div id="yearLabel">Year: 2025</div>
    <input type="range" id="yearSlider" min="1995" max="2039" step="1" value="2025" />

    <button id="storyBtn"
            style="position:absolute; top:20px; left:50%; transform:translateX(-50%);
                   z-index:300; background:#007bff; color:white; border:none; border-radius:6px;
                   padding:10px 16px; cursor:pointer; font-weight:bold;">‚ñ∂ Story Mode</button>

    <div id="storyText"
         style="position:absolute; bottom:90px; left:50%; transform:translateX(-50%);
                color:white; background:rgba(0,0,0,0.7); padding:12px 20px;
                border-radius:8px; font-size:14px; text-align:center;
                max-width:80%; z-index:300;">Click ‚ñ∂ Story Mode to begin</div>

    <div id="globeViz"></div>

    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://unpkg.com/papaparse@5"></script>
    <script>
      let countriesData;
      let cdaData = {};
      let ghpData = {};
      let parData = {};
      let trendData = {};
      let trendBubbles = [];
      let activeFilters = { high: true, medium: true, low: true };
      let activeTrendFilters = { increasing: true, steady: true, decreasing: true };

      const world = Globe()
        (document.getElementById('globeViz'))
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-day.jpg')
        .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
        .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
        .width(window.innerWidth)
        .height(window.innerHeight);
        

      function loadCSV(filename, dataStore, key) {
        console.log(`Loading ${filename}...`);
        return fetch(filename)
          .then(res => {
            console.log(`${key}: HTTP ${res.status}`);
            if (!res.ok) throw new Error(`HTTP ${res.status} for ${filename}`);
            return res.text();
          })
          .then(csvText => {
            return new Promise((resolve, reject) => {
              Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                  console.log(`${key}: ${results.data.length} rows parsed`);
                  
                  let count = 0;
                  results.data.forEach(row => {
                    if (row.country && row.year && row.predicted_value !== null && row.predicted_value !== undefined) {
                      const countryName = row.country.trim();
                      if (!dataStore[countryName]) {
                        dataStore[countryName] = {};
                      }
                      dataStore[countryName][row.year] = row.predicted_value;
                      count++;
                    }
                  });

                  console.log(`${key}: ${Object.keys(dataStore).length} countries, ${count} data points`);
                  console.log(`${key} sample countries:`, Object.keys(dataStore).slice(0, 5));
                  resolve();
                },
                error: function(error) {
                  console.error(`${key}: Parse error`, error);
                  reject(error);
                }
              });
            });
          })
          .catch(error => {
            console.error(`${key}: ERROR`, error);
            throw error;
          });
      }

      function loadTrendClusters() {
        console.log('Loading co2_trend_clusters.csv...');
        return fetch('co2_trend_clusters.csv')
          .then(res => {
            console.log(`Trend clusters: HTTP ${res.status}`);
            if (!res.ok) throw new Error(`HTTP ${res.status} for co2_trend_clusters.csv`);
            return res.text();
          })
          .then(csvText => {
            return new Promise((resolve, reject) => {
              Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                  console.log(`Trend clusters: ${results.data.length} rows parsed`);
                  
                  results.data.forEach(row => {
                    if (row.country && row.trend_label) {
                      trendData[row.country.trim()] = row.trend_label.trim();
                    }
                  });

                  console.log(`Trend data loaded for ${Object.keys(trendData).length} countries`);
                  resolve();
                },
                error: function(error) {
                  console.error('Trend clusters: Parse error', error);
                  reject(error);
                }
              });
            });
          })
          .catch(error => {
            console.error('Trend clusters: ERROR', error);
            throw error;
          });
      }

      Promise.all([
        loadCSV('CDA_predictions_2030.csv', cdaData, 'CDA'),
        loadCSV('GHP_predictions_2030.csv', ghpData, 'GHP'),
        loadCSV('PAR_predictions_2030.csv', parData, 'PAR'),
        loadTrendClusters()
      ])
      .then(() => {
        console.log('All CSV files loaded successfully');
        loadWorldMap();
      })
      .catch(error => {
        console.error('FATAL ERROR:', error);
        document.getElementById('loading').innerHTML = 
          '<div style="color: #ff6666;">Error loading data<br/>' + 
          error.message + '<br/>Check console (F12) for details</div>';
      });

      // Get centroid from polygon coordinates
      function getCentroid(geometry) {
        let coords;
        if (geometry.type === 'Polygon') {
          coords = geometry.coordinates[0];
        } else if (geometry.type === 'MultiPolygon') {
          coords = geometry.coordinates[0][0];
        } else {
          return null;
        }
        
        let sumLat = 0, sumLng = 0, count = 0;
        coords.forEach(coord => {
          sumLng += coord[0];
          sumLat += coord[1];
          count++;
        });
        
        return {
          lat: sumLat / count,
          lng: sumLng / count
        };
      }

      // Create trend bubbles at country centroids only
      function createTrendBubbles() {
        trendBubbles = [];
        
        countriesData.features.forEach(feature => {
          const countryName = feature.properties.ADMIN || feature.properties.NAME;
          const trend = findTrendData(countryName);
          
          if (trend && feature.geometry) {
            const centroid = getCentroid(feature.geometry);
            
            if (centroid) {
              let color = '#888';
              let size = 0.6;
              
              if (trend === 'Increasing') {
                color = '#FF6B35';
                size = 0.7;
              } else if (trend === 'Steady') {
                color = 'purple';
                size = 0.6;
              } else if (trend === 'Decreasing') {
                color = '#95E1D3';
                size = 0.65;
              }
              
              // Just one bubble at the center of each country
              trendBubbles.push({
                lat: centroid.lat,
                lng: centroid.lng,
                size: size,
                color: color,
                name: countryName,
                trend: trend,
                trendKey: trend.toLowerCase()
              });
            }
          }
        });
        
        console.log(`Created ${trendBubbles.length} trend bubbles`);
        updateTrendBubbles();
      }

      function updateTrendBubbles() {
      const filteredBubbles = trendBubbles.filter(b => {
        // Only show bubbles if country exists and trendVisible is true
        const feature = countriesData.features.find(f => f.properties.ADMIN === b.name || f.properties.NAME === b.name);
        return feature && feature.properties.trendVisible;
      });

      world.pointsData(filteredBubbles)
          .pointAltitude(0.01)
          .pointColor('color')
          .pointRadius(d => d.size)
          .pointLabel(d => `
            <div style="background: rgba(0,0,0,0.9); color: white; padding: 10px; border-radius: 4px; font-family: Arial;">
              <b style="color: ${d.color};">${d.name}</b><br/>
              <span style="font-size: 12px;">Emission Trend: ${d.trend}</span>
            </div>
          `);

      console.log(`Displaying ${filteredBubbles.length} trend bubbles`);
    }


      function loadWorldMap() {
        console.log('Loading world map...');
        fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson')
          .then(res => res.json())
          .then(data => {
            countriesData = data;
            console.log(`Map loaded: ${countriesData.features.length} countries`);
            
            createTrendBubbles();
            updateYear(2025);

            world
              .polygonsData(countriesData.features)
              .polygonAltitude(0.01)
              .polygonCapColor(d => getCountryColor(d))


              .polygonSideColor(d => d.properties.visible ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.05)')
              .polygonStrokeColor(d => d.properties.visible ? '#111' : '#333')
              .polygonLabel(d => {
                const name = d.properties.ADMIN || d.properties.NAME || 'Unknown';
                const cda = d.properties.cda;
                const ghp = d.properties.ghp;
                const par = d.properties.par;
                const trend = d.properties.trend_label;
                
                const hasCDA = cda !== null && cda !== undefined;
                const hasGHP = ghp !== null && ghp !== undefined;
                const hasPAR = par !== null && par !== undefined;
                const hasTrend = trend !== null && trend !== undefined;
                
                let trendColor = '#888';
                if (trend === 'Increasing') trendColor = '#FF6B35';
                else if (trend === 'Decreasing') trendColor = '#95E1D3';
                else if (trend === 'Steady') trendColor = '#4ECDC4';
                
                return `
                  <div style="background: rgba(0,0,0,0.95); color: white; padding: 14px; border-radius: 6px; max-width: 260px; font-family: Arial;">
                    <b style="font-size: 15px; color: #4fc3f7;">${name}</b><br/>
                    <hr style="border: none; border-top: 1px solid #555; margin: 10px 0;"/>
                    <div style="font-size: 12px; line-height: 1.6;">
                      <div style="margin-bottom: 8px;">
                        <b style="color: #ff9800;">CDA (CO‚ÇÇ):</b> ${hasCDA ? cda.toFixed(2) : 'No data'}<br/>
                        ${hasCDA ? `<span style="font-size: 10px; color: #aaa;">Status: ${d.properties.pollution_level}</span>` : ''}
                      </div>
                      <div style="margin-bottom: 8px;">
                        <b style="color: #4caf50;">GHP (GHG/capita):</b> ${hasGHP ? ghp.toFixed(2) : 'No data'}
                      </div>
                      <div style="margin-bottom: 8px;">
                        <b style="color: #f44336;">PAR (PM2.5):</b> ${hasPAR ? par.toFixed(2) : 'No data'}
                      </div>
                      ${hasTrend ? `
                      <div style="margin-bottom: 8px; padding: 6px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                        <b style="color: ${trendColor};">Trend:</b> ${trend}
                      </div>
                      ` : ''}
                      <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #444;">
                        <b style="color: #90caf9;">Year:</b> ${d.properties.year}
                      </div>
                    </div>
                  </div>
                `;
              });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('trendControls').style.display = 'block';
            
            setupLegendFilters();
            setupTrendFilters();
            
            console.log('Globe ready!');
          })
          .catch(error => {
            console.error('Map loading error:', error);
            document.getElementById('loading').innerHTML = 
              '<div style="color: #ff6666;">Error loading world map<br/>' + 
              error.message + '</div>';
          });
      }

      function setupLegendFilters() {
        const legendItems = document.querySelectorAll('#controls .legend-item');
        
        legendItems.forEach(item => {
          item.addEventListener('click', () => {
            const level = item.getAttribute('data-level');
            
            activeFilters[level] = !activeFilters[level];
            
            if (activeFilters[level]) {
              item.classList.add('active');
              item.classList.remove('inactive');
            } else {
              item.classList.remove('active');
              item.classList.add('inactive');
            }
            
            applyFilters();
          });
        });
      }

      function setupTrendFilters() {
        const trendItems = document.querySelectorAll('#trendControls .legend-item');
        
        trendItems.forEach(item => {
          item.addEventListener('click', () => {
            const trend = item.getAttribute('data-trend');
            
            activeTrendFilters[trend] = !activeTrendFilters[trend];
            
            if (activeTrendFilters[trend]) {
              item.classList.add('active');
              item.classList.remove('inactive');
            } else {
              item.classList.remove('active');
              item.classList.add('inactive');
            }
            
            applyFilters();
          });
        });
      }

      function applyFilters() {
      if (!countriesData) return;

      countriesData.features.forEach(feature => {
        const level = feature.properties.pollution_level_key;
        const trendKey = feature.properties.trend_label_key;

        // Separate visibility flags
        feature.properties.levelVisible = activeFilters[level] || level === 'nodata';
        feature.properties.trendVisible = activeTrendFilters[trendKey] || trendKey === 'notrend';
      });

  // Update polygons (CO2 colors)
  world.polygonCapColor(d => d.properties.levelVisible ? getCountryColor(d) : 'rgba(50,50,50,0.3)');


  // Update trend bubbles independently
  updateTrendBubbles();

  console.log('Filters applied - Levels:', activeFilters, 'Trends:', activeTrendFilters);
}


      function findCountryData(featureName, year, dataStore) {
        // Enhanced name mapping for better matching
        const nameMap = {
      'United States of America': 'United States',
      'United States': 'United States of America',
      'USA': 'United States of America',
      'Russian Federation': 'Russia',
      'Republic of Korea': 'South Korea',
      'Democratic Republic of the Congo': 'Congo',
      'Czech Republic': 'Czechia',
      'United Kingdom': 'United Kingdom',
      'Britain': 'United Kingdom'
    };

        
        // Try direct match first
        if (dataStore[featureName] && dataStore[featureName][year] !== undefined) {
          return dataStore[featureName][year];
        }
        
        // Try mapped name
        const mappedName = nameMap[featureName];
        if (mappedName && dataStore[mappedName] && dataStore[mappedName][year] !== undefined) {
          return dataStore[mappedName][year];
        }
        
        // Try case-insensitive search
        const lowerName = featureName.toLowerCase();
        for (let country in dataStore) {
          if (country.toLowerCase() === lowerName && dataStore[country][year] !== undefined) {
            return dataStore[country][year];
          }
        }
        
        return null;
      }

      function findTrendData(featureName) {
        const nameMap = {
          'United States of America': 'United States',
          'USA': 'United States',
          'Russian Federation': 'Russia',
          'Republic of Korea': 'South Korea',
          'Democratic Republic of the Congo': 'Congo',
          'Czech Republic': 'Czechia',
          'United Kingdom': 'United Kingdom'
        };
        
        if (trendData[featureName]) {
          return trendData[featureName];
        }
        
        const mappedName = nameMap[featureName];
        if (mappedName && trendData[mappedName]) {
          return trendData[mappedName];
        }
        
        const lowerName = featureName.toLowerCase();
        for (let country in trendData) {
          if (country.toLowerCase() === lowerName) {
            return trendData[country];
          }
        }
        
        return null;
      }

      function updateYear(year) {
        if (!countriesData) return;
        
        let countriesWithCDA = 0;
        let countriesWithGHP = 0;
        let countriesWithPAR = 0;
        let countriesWithTrend = 0;
        
        countriesData.features.forEach(feature => {
          const countryName = feature.properties.ADMIN || feature.properties.NAME || 'Unknown';
          
          const cda = findCountryData(countryName, year, cdaData);
          const ghp = findCountryData(countryName, year, ghpData);
          const par = findCountryData(countryName, year, parData);
          const trend = findTrendData(countryName);
          
          if (cda !== null) {
            countriesWithCDA++;
            feature.properties.cda = cda;
            feature.properties.pollution_level = cda > 66 ? 'High' : cda > 33 ? 'Medium' : 'Low';
            feature.properties.pollution_level_key = cda > 66 ? 'high' : cda > 33 ? 'medium' : 'low';
          } else {
            feature.properties.cda = null;
            feature.properties.pollution_level = 'No Data';
            feature.properties.pollution_level_key = 'nodata';
          }
          
          if (ghp !== null) countriesWithGHP++;
          feature.properties.ghp = ghp;
          
          if (par !== null) countriesWithPAR++;
          feature.properties.par = par;
          
          if (trend !== null) {
            countriesWithTrend++;
            feature.properties.trend_label = trend;
            feature.properties.trend_label_key = trend.toLowerCase();
          } else {
            feature.properties.trend_label = null;
            feature.properties.trend_label_key = 'notrend';
          }
          
          feature.properties.year = year;
          
          const level = feature.properties.pollution_level_key;
          const trendKey = feature.properties.trend_label_key;
          feature.properties.levelVisible = activeFilters[level] || level === 'nodata';
          feature.properties.trendVisible = activeTrendFilters[trendKey] || trendKey === 'notrend';

        });
        
        console.log(`Year ${year}: CDA=${countriesWithCDA}, GHP=${countriesWithGHP}, PAR=${countriesWithPAR}, Trend=${countriesWithTrend} countries`);
        
        world.polygonCapColor(d => d.properties.levelVisible ? getCountryColor(d) : 'rgba(50,50,50,0.3)');

        updateTrendBubbles();

        document.getElementById('yearLabel').textContent = "Year: " + year;
      }

      document.getElementById('yearSlider').addEventListener('input', (e) => {
        updateYear(+e.target.value);
      });

      world.controls().autoRotate = true;
      world.controls().autoRotateSpeed = 0.3;
      world.controls().enableZoom = true;

      window.addEventListener('resize', () => {
        world.width(window.innerWidth).height(window.innerHeight);
      });

      // STORY MODE
      const storyPoints = [
        { country: "United States", lat: 40.71, lng: -74.00, year: 2000, text: "2000: Rising emissions in North America." },
        { country: "Japan", lat: 35.68, lng: 139.69, year: 2010, text: "2010: Industrial growth impacts East Asia." },
        { country: "Brazil", lat: -23.55, lng: -46.63, year: 2020, text: "2020: South America focuses on sustainability." },
        { country: "United Kingdom", lat: 51.51, lng: -0.13, year: 2025, text: "2025: Global collaboration stabilizes CO‚ÇÇ." }
      ];
      function getCountryColor(d) {
        const cda = d.properties.cda;
        if (cda === null || cda === undefined) return 'rgba(50,50,50,0.3)';
        if (cda > 66) return '#d73027';
        if (cda > 33) return '#cba125';
        return '#4daf4a';
}



    function highlightCountry(countryName) {
        if (!countriesData) return;

        const feature = countriesData.features.find(f => {
          const name = f.properties.ADMIN || f.properties.NAME;
          return name === countryName || name.includes(countryName);
        });
        if (!feature) return;

        // Save the original color
        const originalColor = getCountryColor(feature);

        let blinkCount = 0;
        const maxBlinks = 12;
        const blinkInterval = setInterval(() => {
          feature.properties._highlighted = !feature.properties._highlighted;

          world.polygonsData(countriesData.features)
            .polygonCapColor(d => {
              if (d === feature) {
                return d.properties._highlighted ? 'rgba(255, 215, 0, 0.8)' : getCountryColor(d);
 // use original color
              }
              return getCountryColor(d);
            });

          blinkCount++;
          if (blinkCount >= maxBlinks) {
            clearInterval(blinkInterval);
            feature.properties._highlighted = false;
            world.polygonsData(countriesData.features)
              .polygonCapColor(d => getCountryColor(d));
          }
        }, 500);
    }

    function restoreCountryColors() {
    world.polygonsData(countriesData.features)
    .polygonCapColor(d => d.properties.visible ? d.properties.fillColor : 'rgba(50,50,50,0.3)');
}




      async function playStory() {
        const btn = document.getElementById('storyBtn');
        const textBox = document.getElementById('storyText');
        btn.disabled = true;

        for (const point of storyPoints) {
          world.pointOfView({ lat: point.lat, lng: point.lng, altitude: 2.0 }, 2000);
          highlightCountry(point.country);

          const year = point.year;
          const country = point.country;

          updateYear(year);

          const cda = findCountryData(country, year, cdaData);
          const ghp = findCountryData(country, year, ghpData);
          const par = findCountryData(country, year, parData);
          const trend = findTrendData(country);

          const dataHTML = `
            <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
              <b>${country}</b> (${year})<br/>
              CDA: ${cda !== null ? cda.toFixed(2) : 'No data'}<br/>
              GHP: ${ghp !== null ? ghp.toFixed(2) : 'No data'}<br/>
              PAR: ${par !== null ? par.toFixed(2) : 'No data'}<br/>
              Trend: ${trend || 'No data'}
            </div>
          `;

          textBox.innerHTML = `${point.text}${dataHTML}`;

          const yearSlider = document.getElementById('yearSlider');
          if (yearSlider) {
            yearSlider.value = year;

            restoreCountryColors();
          }

          await new Promise(resolve => setTimeout(resolve, 5000));
        }

        textBox.innerHTML = "Try it out and explore freely!";
        btn.disabled = false;
      }
      
      document.getElementById('storyBtn').addEventListener('click', playStory);
    </script>
  </body>
</html>